<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Watch Movie</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
    <style>
        body { background: #111; color: #fff; font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; }
        .player-wrapper { max-width: 960px; margin: 20px auto; }
        video { width: 100%; height: 600px; border: none; }
        .dub-buttons { margin-top: 20px; }
        .dub-buttons button {
            background: #333;
            color: white;
            border: 1px solid #666;
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
            border-radius: 6px;
        }
        .dub-buttons button.active {
            background-color: #007bff;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <h1>🎬 Loading your movie...</h1>
    <div class="dub-buttons" id="dub-selector"></div>
    <div class="player-wrapper">
        <video id="player" playsinline controls crossorigin="anonymous"></video>
    </div>
    <p><small>Note: Short ad plays first, then your movie starts automatically.</small></p>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = window.location.pathname.split("/").pop();
        const lang = urlParams.get("lang") || "ua";
        const defaultDub = urlParams.get("dub") || null;

        const playerElement = document.getElementById('player');
        const dubSelector = document.getElementById('dub-selector');
        const adSource = "/static/ad_dummy.mp4";
        let adPlaying = true;
        let lastTime = 0;

        let player = new Plyr('#player', {
            controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
            settings: ['quality']
        });

        let hls = null;

        function setupQualitySelector(hlsInstance) {
            const availableQualities = hlsInstance.levels.map((l) => ({
                label: l.height + 'p',
                value: l.height
            })).reverse();

            availableQualities.unshift({ label: 'Auto', value: 'auto' });

            console.log("HLS Levels:", hlsInstance.levels);
            console.log("Available Qualities:", availableQualities.map(q => q.label));

            const qualityLabels = availableQualities.map(q => q.label);

            // Destroy previous Plyr instance and recreate it
            if (player) {
                player.destroy();
            }

            player = new Plyr('#player', {
                controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
                settings: ['quality'],
                quality: {
                    default: 'Auto',
                    options: qualityLabels,
                    forced: true,
                    onChange: (newLabel) => {
                        const level = newLabel === 'Auto'
                            ? -1
                            : hlsInstance.levels.findIndex(l => l.height + 'p' === newLabel);
                        hlsInstance.currentLevel = level;
                        console.log(`🎚 Switched to quality: ${newLabel} (level ${level})`);
                    }
                }
            });

            console.log("🛠️ Player recreated with quality options:", qualityLabels);
        }

        function loadDub(dubName, config) {
            const masterUrl = config.m3u8;
            const subtitles = config.subtitles;

            if (hls) {
                hls.destroy();
                hls = null;
            }
            playerElement.removeAttribute('src');
            playerElement.load();

            // Reset player
            if (Hls.isSupported()) {
                playerElement.innerHTML = '';
                hls = new Hls();
                hls.loadSource(masterUrl);
                hls.attachMedia(playerElement);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log("⚙️ Calling setupQualitySelector with levels:", hls.levels);
                    console.log("✅ HLS.js attached, attempting quality selector setup...");
                    if (!hls.levels.length) {
                        alert("⚠️ No video qualities detected. Stream may fail.");
                    }
                    setupQualitySelector(hls);
                    playerElement.play();
                });
            } else if (playerElement.canPlayType('application/vnd.apple.mpegurl')) {
                playerElement.src = masterUrl;
                playerElement.addEventListener('loadedmetadata', () => playerElement.play());
            } else {
                alert('Your browser does not support HLS playback.');
            }

            playerElement.innerHTML = ''; // Clear old subtitles
            subtitles.forEach(sub => {
                const track = document.createElement('track');
                track.kind = 'subtitles';
                track.label = sub.lang || 'Unknown';
                track.srclang = sub.lang || 'xx';
                track.src = sub.url;
                track.default = false;
                playerElement.appendChild(track);
            });

            document.querySelectorAll(".dub-buttons button").forEach(btn => btn.classList.remove("active"));
            const activeBtn = Array.from(document.querySelectorAll(".dub-buttons button")).find(btn => btn.textContent === dubName);
            if (activeBtn) activeBtn.classList.add("active");
        }

        async function initPlayer() {
            try {
                const res = await fetch(`/hd/watch-config/${taskId}`);
                const config = await res.json();
                const langData = config[lang];

                if (!langData) throw new Error("No dubs found for lang: " + lang);

                for (const dubName in langData) {
                    const btn = document.createElement("button");
                    btn.textContent = dubName;
                    btn.onclick = () => loadDub(dubName, langData[dubName]);
                    dubSelector.appendChild(btn);
                }

                const initialDub = defaultDub && langData[defaultDub] ? defaultDub : Object.keys(langData)[0];
                loadDub(initialDub, langData[initialDub]);
                document.querySelector("h1").textContent = `🎬 Now Watching: ${initialDub}`;
            } catch (e) {
                document.querySelector("h1").textContent = `❌ Failed to load movie.`;
                console.error(e);
            }
        }

        playerElement.src = adSource;
        playerElement.play();
        playerElement.addEventListener('seeking', () => {
            if (adPlaying && playerElement.currentTime > lastTime + 0.5) {
                playerElement.currentTime = lastTime;
            }
        });
        playerElement.addEventListener('timeupdate', () => {
            if (adPlaying) lastTime = playerElement.currentTime;
        });
        playerElement.addEventListener('ended', () => {
            if (adPlaying) {
                adPlaying = false;
                initPlayer();
            }
        });

        setTimeout(() => {
            if (adPlaying) {
                adPlaying = false;
                initPlayer();
            }
        }, 10000); // max ad duration fallback
    </script>
</body>
</html>
